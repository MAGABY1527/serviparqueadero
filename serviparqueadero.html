<script>
  async function cargarDatos() {
    const params = new URLSearchParams(window.location.search);

    // Campos visibles
    setText("fecha",    params.get("fecha"));
    setText("norecibo", params.get("norecibo"));
    setText("placa",    params.get("placa"));
    setText("ingreso",  params.get("ingreso"));
    setText("salida",   params.get("salida"));
    setText("total",    params.get("total"));

    // Precio opcional
    const precio = params.get("precio");
    if (precio) {
      setText("precio", precio);
      document.getElementById("row-precio").classList.remove("hidden");
    }

    // URL del logo: si no viene por param, usa la tuya por defecto
    const urlLogo = params.get("imagen")
      || "https://raw.githubusercontent.com/MAGABY1527/serviparqueadero/main/servipark.jpg";

    // 1) Descarga el logo y conviértelo a data URL (Base64)
    const dataUrl = await toDataURL(urlLogo);

    // 2) Colócalo en el <img> y espera a que se “decodifique”
    const logo = document.getElementById("logoRecibo");
    logo.src = dataUrl;
    if (logo.decode) {
      try { await logo.decode(); } catch (_) {}
    } else {
      await waitForImage(logo);
    }

    // 3) (Opcional) Espera fuentes si usas Google Fonts
    if (document.fonts && document.fonts.ready) {
      try { await document.fonts.ready; } catch (_) {}
    }

    // 4) Imprime con un micro-delay para asegurar el reflow final
    setTimeout(() => window.print(), 50);
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value || "";
  }

  function waitForImage(img) {
    if (!img) return Promise.resolve();
    if (img.complete) return Promise.resolve();
    return new Promise((resolve) => {
      img.addEventListener("load", resolve, { once: true });
      img.addEventListener("error", resolve, { once: true });
    });
  }

  async function toDataURL(url) {
    // Evita caché para que el navegador no “pierda” la imagen en el re-render
    const res = await fetch(url, { cache: "reload", mode: "cors" });
    const blob = await res.blob();
    // Convierte a Base64
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  // Asegura que, si el sistema reabre el diálogo, el logo ya esté embebido
  window.addEventListener("beforeprint", () => {
    const img = document.getElementById("logoRecibo");
    // Forzamos visibilidad por si el motor de impresión intenta ocultarlo
    img.style.visibility = "visible";
  });
</script>
